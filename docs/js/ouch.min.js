var connection,actions,public_exist,timeout,header=document.getElementById("header"),exist_input=document.getElementById("exist-input"),user_input=document.getElementById("user-input"),chat=document.getElementById("chat"),leaderboard=document.getElementsByClassName("leaderboard")[0],level=document.getElementById("level"),box=document.getElementById("box"),search=document.getElementById("search"),ouch=document.getElementById("ouch"),submit_button=document.getElementById("submit-button"),reconnect_button=document.getElementById("reconnect-button"),help=document.getElementById("help"),indicator=document.getElementById("indicator"),world_value=document.getElementById("world-value"),loading=document.getElementById("loading"),commands=document.getElementById("commands"),chatindic=document.getElementById("chat-indic"),helpicon=document.getElementById("help-icon"),login_status=document.getElementById("login-status"),login_style=document.getElementById("login-type-toggle"),actions_help=document.getElementById("actions-help"),help_background=document.getElementById("help"),search_items=document.getElementsByClassName("search-item"),search_items=document.getElementsByClassName("panel"),existing_msg="have an existing existence?",new_exist_msg="dont have an existence?",login=!1,enteredOnce=!1,nickname="user",id="id",allowedInput=/^[a-z0-9]+$/i,url_base="sim-ouch.herokuapp.com",url_ws="wss://"+url_base+"/ws",url_actions="https://"+url_base+"/actions",url_status="https://"+url_base+"/status",reconnect_token=null,close_code={ER_NO_NAME:4005,ER_EX_NOT_FOUND:4004,ER_Q_NOT_FOUND:4040,ER_BAD_TOKEN:4007,ER_INTERNAL_GENERIC:4010},ping_packet='{"dataType":"PING","data":"PING"}',usr_disconnected=!1,reconnecting=!1,searching=!1,here=!0,inactive=3e4;function switchState(){(null!=reconnect_token?reconnect_button:submit_button).classList.toggle("hidden"),box.classList.toggle("opacity"),user_input.classList.toggle("login"),exist_input.classList.toggle("login"),header.classList.toggle("login"),exist_input.classList.toggle("opacity"),exist_input.classList.toggle("disappear"),level.classList.toggle("opacity"),leaderboard.classList.toggle("opacity"),login_status.classList.toggle("opacity"),login_status.classList.toggle("disappear"),login_style.classList.toggle("opacity"),login_style.classList.toggle("disappear"),login=!login,getHTTP(url_status,setPublicExist)}function switchLoginType(){existing_msg===login_style.innerHTML?(login_style.innerHTML=new_exist_msg,exist_input.classList.remove("input-shrink")):(login_style.innerHTML=existing_msg,exist_input.classList.add("input-shrink"))}function switchSearch(){search.classList.toggle("opacity"),search.classList.toggle("disappear"),chat.classList.toggle("opacity"),chat.classList.toggle("disappear"),searching=!searching}function switchDark(){ouch.classList.toggle("dark"),header.classList.toggle("dark"),chat.classList.toggle("dark")}function togglePopUp(){help.classList.toggle("opacity")}function switchLoading(e){e?(commands.classList.toggle("opacity"),setTimeout(function(){loading.classList.toggle("disappear"),loading.classList.toggle("opacity")},1e3)):(loading.classList.toggle("opacity"),loading.classList.toggle("disappear"),setTimeout(function(){commands.classList.toggle("opacity")},1e3))}function switchChatIndic(){chatindic.classList.toggle("disappear"),chatindic.classList.toggle("opacity")}var bottom=function(){chat.scrollTop=chat.scrollHeight};function scrollBottom(){bottom()}function shake(e){e.classList.add("shake"),setTimeout(function(){e.classList.remove("shake")},1e3)}function reset(){switchState(),indicator.classList.toggle("connected"),world_value.innerHTML="offline",leaderboard.innerHTML="",chat.innerHTML="",user_input.value="",user_input.placeholder="username",enteredOnce=!1,ouch.innerHTML="Ouch",searching&&switchSearch()}function addChat(e,t,n){var s="";"system"===n?s='<div class="chat-msg-cont"><p class="chat-msg system"><span style="font-weight: bold;">'+e+"</span> "+t+"</p></div>":e!==nickname&&"client"===n?s='<div class="chat-msg-cont"><p class="chat-msg '+n+'"><span style="font-weight: bold;">'+e+": </span>"+t+"</p></div>":e===nickname&&"client"===n&&(s='<div class="chat-msg-cont"><p class="chat-msg user">'+t+"</p></div>"),chat.innerHTML+=s,scrollBottom()}function loadActionsHelp(){for(var e="<table>",t=0;t<actions.length;t++)e+='<tr><td><span class="bold">'+actions[t].callform+"</span></td><td>"+actions[t].description+"</td></tr>";actions_help.innerHTML=e+="</table>"}function chatIndic(){scrollBottom(),bottom()}function makeChatMessage(e){return'{"dataType":"CHAT","data":"'+e+'"}'}function handleInit(e){var t,n=e.existence,s=e.quiddity,c=(reconnect_token=e.token,level.innerHTML=s.name+' <span id="level-value" class="normal">'+s.ouch.level+"</span>",world_value.innerHTML=e.existence._id,user_input.placeholder="enter command or message",indicator.classList.toggle("await"),indicator.classList.toggle("connected"),n.quidities);for(t in c)leaderboard.innerHTML+='<div class="data-leaderboard-cont"><p class="data-leaderboard '+c[t].id+'">'+c[t].name+' <span class="normal">'+c[t].ouch.level+"</span></p></div>";for(var o=n.chat.history,i=0;i<o.length;i++){var a=o[i];addChat(a.authorName,a.content,"client")}setTimeout(function(){switchLoading(!1)},1e3)}function handleQuid(e,t,n){var s=document.getElementById("level-value");t===nickname&&(s.innerHTML=n),document.getElementsByClassName(e)[0].childNodes[1].innerHTML=n}function heartbeat(){connection&&1===connection.readyState&&here&&connection.send(ping_packet)}function createConnection(e){switchLoading(!0),inactivityTime(),(connection=new WebSocket(e)).onopen=function(){switchState(),indicator.classList.toggle("await"),world_value.innerHTML="connecting",user_input.value="",user_input.placeholder="connecting to the Existence...",heartbeat()},connection.onerror=function(e){alert("WebSocket error:"+e)},connection.onmessage=function(e){console.log(e);var t=JSON.parse(e.data),n=JSON.parse(t.data);switch(t.type){case"INIT":handleInit(n);break;case"CHAT":addChat(n.authorName,n.content,"client");break;case"QUIDDITY":handleQuid(n.id,n.name,n.ouch.level);break;case"ENTER":leaderboard.innerHTML+='<div class="data-leaderboard-cont"><p class="data-leaderboard '+n.id+'">'+n.name+' <span class="normal">'+n.ouch.level+"</span></p></div>",addChat(n.name,"has joined the Existence.","system");break;case"EXIT":console.log(n);var s=document.getElementsByClassName(n.id)[0];s.parentNode.removeChild(s),addChat(n.name,"has left the Existence.","system");break;case"PING":case"ERR":break;default:console.log("Unknown packet type"),console.log(e.data)}},connection.onclose=function(e){switch(reset(),e.code){case close_code.ER_NO_NAME:shake(user_input);break;case close_code.ER_BAD_ID:exist_input.value="",exist_input.placeholder="Unknown ID",user_input.value=nickname,shake(exist_input);break;case close_code.ER_INTERNAL_GENERIC:alert("Sorry, an internal error occurred. Please try again");break;case close_code.ER_BAD_TOKEN:reconnect_token=null;break;default:usr_disconnected?usr_disconnected=!1:reconnect_button.onclick()}here=!1}}function getHTTP(e,t){var n=t;fetch(e,{method:"GET",mode:"cors"}).then(function(e){var t=e.json();200<=e.status&&e.status<300?Promise.resolve(t).then(function(e){return n(e),e}):n(t.then(Promise.reject.bind(Promise)))})}var setActions=function(e){""===(actions=e)&&console.log("Error"),loadActionsHelp()},setPublicExist=function(e){""===(public_exist=e)?console.log("Error"):login_status.innerHTML='Live Sessions: <span class="normal">'+public_exist.numLiveSes+' | </span> Live Existences: <span class="normal">'+public_exist.numLiveEx+' | </span> Dormant Existences: <span class="normal">'+public_exist.numDormEx+"</span> "};function inactivityTime(){window.onload=resetTimer,document.onmousemove=resetTimer,document.onkeypress=resetTimer}function timedOut(){usr_disconnected=!(here=!1),connection.close()}function resetTimer(){clearTimeout(timeout),here=!0,timeout=setTimeout(timedOut,inactive)}function processInput(e){if(here=!0,13===event.key||"Enter"===event.key||!0===e){e=user_input.value;if(login)return""!==e&&e.match(allowedInput)?!enteredOnce||void 0:(shake(user_input),!1);event.preventDefault(),""===e?shake(user_input):"-"===e.charAt(0)?processCommands(e):1==connection.readyState?connection.send(makeChatMessage(e)):console.log("web socket is not connected"),user_input.value=""}}function processCommands(e){switch(e){case"-theme":switchDark();break;case"-bean":ouch.innerHTML='<object data="imgs/bean.svg" type="image/svg+xml" style="width: 200px;"></object>';break;case"-exit":usr_disconnected=!0,connection.close();break;case"-helo":ouch.innerHTML="Ouch";break;default:console.log("action "+e)}}function autocompleteSearch(e){search.innerHTML="";for(var t=0,n=0;n<actions.length;n++)actions[n].callform.includes(e)&&(t++,search.innerHTML+='<div class="search-item">'+actions[n].callform+"</div>");0===t&&(search.innerHTML+='<div class="search-item">No Matches</div>');for(n=0;n<search_items.length;n++)n!==search_items.length-1&&search_items[n].classList.add("search-bottom-border"),search_items[n].onclick=function(e){autofill(e.target.innerHTML)};searching=!0}function autofill(e){user_input.value="",processCommands(e),switchSearch()}exist_input.addEventListener("keydown",function(e){processInput()&&submit_button.click()}),user_input.addEventListener("keydown",function(e){processInput()&&submit_button.click()}),user_input.addEventListener("keyup",function(e){"-"===user_input.value.charAt(0)?(searching||switchSearch(),login||autocompleteSearch(user_input.value)):searching&&(switchSearch(),searching=!1)}),reconnect_button.onclick=function(){reconnecting=!0,createConnection(url_ws+"?token="+reconnect_token)},submit_button.onclick=function(){nickname=user_input.value,id=exist_input.value,processInput(!0)&&(""===id?(enteredOnce=!0,createConnection(url_ws+"?name="+nickname)):(enteredOnce=!0,createConnection(url_ws+"?name="+nickname+"&exID="+id.toUpperCase())))},document.getElementsByClassName("close")[0].onclick=function(){togglePopUp(),setTimeout(function(){help.classList.add("zindex")},1e3)},helpicon.onclick=function(){help.classList.remove("zindex"),togglePopUp()},login_style.onclick=function(){switchLoginType()},document.onbeforeunload=function(){connection.close()},window.onload=function(){getHTTP(url_actions,setActions),getHTTP(url_status,setPublicExist)};
